#!/usr/bin/env node

import fs from "node:fs";
import path from "node:path";

const args = process.argv.slice(2);

function printUsageAndExit(message) {
  if (message) {
    console.error(message);
  }
  console.error(
    "Usage: node scripts/generate-skattetabell.mjs --input <path> --year <year> --out <path>"
  );
  process.exit(1);
}

function parseArgs() {
  const options = {};
  for (let i = 0; i < args.length; i += 2) {
    const key = args[i];
    const value = args[i + 1];
    if (!key || !value) {
      printUsageAndExit();
    }
    switch (key) {
      case "--input":
        options.input = value;
        break;
      case "--year":
        options.year = value;
        break;
      case "--out":
        options.out = value;
        break;
      default:
        printUsageAndExit(`Unknown option ${key}`);
    }
  }
  const required = ["input", "year", "out"];
  for (const key of required) {
    if (!options[key]) {
      printUsageAndExit(`Missing required option --${key}`);
    }
  }
  return options;
}

function readCsv(filePath) {
  const raw = fs.readFileSync(filePath, { encoding: "latin1" });
  const lines = raw.split(/\r?\n/).filter((line) => line.trim().length > 0);
  const header = lines.shift();
  if (!header) {
    throw new Error("CSV file is empty");
  }
  const columns = header
    .split(";")
    .map((column) => column.replace(/^\uFEFF/, "").trim());
  const records = lines.map((line, index) => {
    const parts = line.split(";");
    if (parts.length < columns.length) {
      throw new Error(`Row ${index + 2} does not have ${columns.length} columns`);
    }
    const record = {};
    for (let i = 0; i < columns.length; i++) {
      record[columns[i]] = (parts[i] ?? "").trim();
    }
    return record;
  });
  return { records, columns };
}

const YEAR_KEY = "År";
function getColumn(row, key, fallbackKey) {
  if (row[key] !== undefined) return row[key];
  if (fallbackKey && row[fallbackKey] !== undefined) return row[fallbackKey];
  return undefined;
}
function emitModule(records, exportName, headers) {
  const lines = [];
  lines.push("/* Auto-generated by scripts/generate-skattetabell.mjs */");
  lines.push("/* eslint-disable */");
  lines.push(`export const ${exportName} = [`);
  for (const row of records) {
    lines.push("  {");
    headers.forEach((header, index) => {
      const key = JSON.stringify(header);
      const value = JSON.stringify(row[header] ?? "");
      const suffix = index === headers.length - 1 ? "" : ",";
      lines.push(`    ${key}: ${value}${suffix}`);
    });
    lines.push("  },");
  }
  lines.push("] as const;\n");
  return lines.join("\n");
}

function main() {
  const options = parseArgs();
  const resolvedInput = path.resolve(options.input);
  const { records, columns } = readCsv(resolvedInput);
  const filtered = records.filter((row) => getColumn(row, YEAR_KEY, "år") === options.year);

  if (filtered.length === 0) {
    throw new Error(`No rows found for år=${options.year}`);
  }

  const headers = columns;
  const moduleSource = emitModule(filtered, `SKATTETABELL_${options.year}`, headers);
  const outPath = path.resolve(options.out);
  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, moduleSource, { encoding: "utf8" });
}

main();
