#!/usr/bin/env node

import fs from "node:fs";
import path from "node:path";

const args = process.argv.slice(2);

function printUsageAndExit(message) {
  if (message) {
    console.error(message);
  }
  console.error(
    "Usage: node scripts/generate-skattetabell.mjs --input <path> --year <year> --antal <antal> --tabell <tabell> --out <path>"
  );
  process.exit(1);
}

function parseArgs() {
  const options = {};
  for (let i = 0; i < args.length; i += 2) {
    const key = args[i];
    const value = args[i + 1];
    if (!key || !value) {
      printUsageAndExit();
    }
    switch (key) {
      case "--input":
        options.input = value;
        break;
      case "--year":
        options.year = value;
        break;
      case "--antal":
        options.antal = value;
        break;
      case "--tabell":
        options.tabell = value;
        break;
      case "--out":
        options.out = value;
        break;
      default:
        printUsageAndExit(`Unknown option ${key}`);
    }
  }
  const required = ["input", "year", "antal", "tabell", "out"];
  for (const key of required) {
    if (!options[key]) {
      printUsageAndExit(`Missing required option --${key}`);
    }
  }
  return options;
}

function readCsv(filePath) {
  const raw = fs.readFileSync(filePath, { encoding: "latin1" });
  const lines = raw.split(/\r?\n/).filter((line) => line.trim().length > 0);
  const header = lines.shift();
  if (!header) {
    throw new Error("CSV file is empty");
  }
  const columns = header
    .split(";")
    .map((column) => column.replace(/^\uFEFF/, "").trim());
  return lines.map((line, index) => {
    const parts = line.split(";");
    if (parts.length < columns.length) {
      throw new Error(`Row ${index + 2} does not have ${columns.length} columns`);
    }
    const record = {};
    for (let i = 0; i < columns.length; i++) {
      record[columns[i]] = (parts[i] ?? "").trim();
    }
    return record;
  });
}

function parseInteger(value) {
  const trimmed = value.trim();
  if (trimmed === "") {
    return null;
  }
  const parsed = Number.parseInt(trimmed, 10);
  return Number.isNaN(parsed) ? null : parsed;
}

const YEAR_KEY = "År";
const ANTAL_KEY = "Antal dgr";
const TABELL_KEY = "Tabellnr";
const INCOME_FROM_KEY = "Inkomst fr.o.m.";
const INCOME_TO_KEY = "Inkomst t.o.m.";

function getColumn(row, key, fallbackKey) {
  if (row[key] !== undefined) return row[key];
  if (fallbackKey && row[fallbackKey] !== undefined) return row[fallbackKey];
  return undefined;
}

function formatTable(records, { year, antal, tabell }) {
  const filtered = records.filter(
    (row) =>
      getColumn(row, YEAR_KEY, "år") === year &&
      getColumn(row, ANTAL_KEY) === antal &&
      getColumn(row, TABELL_KEY) === tabell
  );

  if (filtered.length === 0) {
    throw new Error(
      `No rows found for år=${year}, Antal dgr=${antal}, Tabellnr=${tabell}`
    );
  }

  return filtered.map((row) => {
    return {
      from: parseInteger(getColumn(row, INCOME_FROM_KEY)),
      to: parseInteger(getColumn(row, INCOME_TO_KEY)),
      columns: {
        1: parseInteger(row["Kolumn 1"]),
        2: parseInteger(row["Kolumn 2"]),
        3: parseInteger(row["Kolumn 3"]),
        4: parseInteger(row["Kolumn 4"]),
        5: parseInteger(row["Kolumn 5"]),
        6: parseInteger(row["Kolumn 6"]),
        7: parseInteger(row["Kolumn 7"]),
      },
    };
  });
}

function toExportName({ tabell, year, antal }) {
  const safeAntal = antal.replace(/[^0-9A-Za-z]/g, "");
  return `SKATTETABELL_${tabell}_${year}_${safeAntal}`;
}

function emitModule(data, meta) {
  const exportName = toExportName(meta);
  const lines = [];
  lines.push("/* Auto-generated by scripts/generate-skattetabell.mjs */");
  lines.push("/* eslint-disable */");
  lines.push("export const " + exportName + " = [");
  for (const row of data) {
    const cols = [1, 2, 3, 4, 5, 6, 7].map((key) => {
      const value = row.columns[key];
      return value === null ? "null" : value;
    });
    lines.push(
      `  { from: ${row.from ?? "null"}, to: ${row.to ?? "null"}, columns: { 1: ${cols[0]}, 2: ${cols[1]}, 3: ${cols[2]}, 4: ${cols[3]}, 5: ${cols[4]}, 6: ${cols[5]}, 7: ${cols[6]} } },`
    );
  }
  lines.push("] as const;\n");
  return lines.join("\n");
}

function main() {
  const options = parseArgs();
  const resolvedInput = path.resolve(options.input);
  const records = readCsv(resolvedInput);
  const data = formatTable(records, {
    year: options.year,
    antal: options.antal,
    tabell: options.tabell,
  });
  const moduleSource = emitModule(data, {
    year: options.year,
    antal: options.antal,
    tabell: options.tabell,
  });
  const outPath = path.resolve(options.out);
  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, moduleSource, { encoding: "utf8" });
}

main();
